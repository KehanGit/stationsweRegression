---
title: "Using this package"
author: "Dominik Schneider"
date: "`r Sys.Date()`"
output:	html_vignette
vignette: >
  %\VignetteIndexEntry{Using this package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


This document will describe how to set up an R script to run the commands needed to estimate SWE distribution. 

# Intro

This package was written to estimate SWE in the northern Rockies using MODSCAG, SNOTEL observations from within the domain, and some precomputed static topographic variables. I've tried to make the package so it can be extended to use e.g. MOD10A1 and CADWR station observations with the appropriate changes.

# Project setup

You should create a working directory from which to run the functions in this package. It should contain

* a directory named `modscag_downloads`
* domain directory, e.g. idwy, that will contain information specific to the domain
* a csv file of the dates you are interested in. This can have any filename, and you will provide the exact name and location later

## modscag_downloads

There are 2 options. Either download the files yourself before running the model, or allow the package to download them for you. 

*Option 1*

You can copy the correct modscag date directories from snowserver `/data/hydroData/WestUS_Data/MODSCAG/modscag-historic/` and the package will skip the download. The structure of the modscag-downloads directory should be:
* year
*	3 digit day of year
* geotiff modscag files with names ending in `snow_fraction.tif`

The package will mosaic these files and crop them for your domain. The processed fsca files will be placed in the folder `data/fsca` inside the domain directory.


*Option 2*

The package will download them for you after checking to make sure the files don't exist. This option requires some setup of ssh on yoru computer. The data for this directory will be automatically downloaded from snow server over ssh (with scp) but you need setup a ssh key file. google to troubleshoot if needed but here is an overview (I've only done this on MacOS. I assume linux is the same. I think for Windows you'll need Cygwin or MobaXTerm or alike):

1. create a directory in your user home called `.ssh`

2. run `ssh-keygen` in terminal (anywhere)
	+ if it asks for the file in which to save the key make sure it gets saved to /Users/<username>/.ssh/snowserver_rsa
	+ if it asks for a passphrase just hit enter for none.
	
3. run `ssh-copy-id -i ~/.ssh/snowserver_rsa.pub snowserver.colorado.edu` 

4. try ssh'ing to snowserver. it should work without a password.
	+ check to make sure the snowserver_rsa was added to ~/.ssh/authorized_keys 
	+ NB: I had to use `ssh snowserver.colorado.edu -i ~/.ssh/snowserver_rsa` which then prompted me for my key passphrase (which we set to none). I think this confuses the mac because it can't store nothing in the keychain. I hit enter a couple times and then it worked the following ssh attempt. Importantly, after logging in you should see: `Identity added: /Users/dosc3612/.ssh/snowserver_rsa ((null)`
	+ if not, try `chmod 700 .ssh` on your .ssh folder on snowserver
	+ also try `chmod 600 .ssh/snowserver_rsa` on your computer to set the permissions
	+ or, recreate the ssh key with a passphrase (rather than not having one)
	
*NB: make sure your username is the same on your local machine and snowserver. otherwise you will need to replace `snowserver.colorado.edu` with `<sslogin>@snowserver.colorado.edu`


## domain directory

You will need to create a `data` subdirectory. Inside `data` you will need to create `phv` and `gis`. 

`phv` contains static predictor variables that you must provide to the model. For a domain name of `idwy`, they must be labeled `idwy_dem.tif` (for elevation). The package will use all geotif files in this folder and parse the name based on the underscore. 

`gis` needs to have a watermask named `IDWY_watermask.tif`. This will be used to mask areas that are bodies of water from the estimates. You need to make sure this is on the same grid as the geotiffs in `phv`. One option is to use the MOD44W product from NASA.

Upon runing the model, 2 additional subfolders (`snoteldownloads` and `fsca`) will be created in the `data` directory. 

An `output` folder will also be created in the domain directory with the results from the model

The resulting folder structure is therefore:

* working directory
	* idwy (user created)
		* data (user created)
			* phv (user created)
			* gis (user created)
			* snoteldownloads -> (auto created) the model will download the relevant snotel data here
			* fsca -> (auto created) the processed modscag files will be written here
			* output -> (auto created) the SWE distribution results will be written here
		
I have an r script to make the phv geotif files. There is [another vignette](Make_PHV_Inputs.html) with this information.


## csv datefile

There should be a single column with a header called `dte` and the date format should be `YYYY-mm-dd`. You will provide the name of this file to run the model.
        

# Run file

see an [example run file](https://github.com/hoargroup/example_sweRegression/blob/master/run_ucrb.R) on github. Here is a [plain text version](https://raw.githubusercontent.com/hoargroup/example_sweRegression/master/run_ucrb.R) you can copy as a template.
